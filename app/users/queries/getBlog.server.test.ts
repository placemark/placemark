import { expect, describe, it, vi } from "vitest";

import { blogParseInner } from "./getBlog";

const fix = `<?xml version="1.0" encoding="utf-8"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/"><channel><title>Placemark blog</title><link>https://www.placemark.io</link><description></description><pubDate>Fri, 29 Apr 2022 14:51:59 GMT</pubDate><generator>Webflow</generator><atom:link href="https://www.placemark.io/post/rss.xml" rel="self" type="application/rss+xml"/><item><title>Changelog: April 25</title><link>https://www.placemark.io/post/changelog-april-25</link><guid>https://www.placemark.io/post/changelog-april-25</guid><description>Just another Monday, with some improvements, fixes, and commentary!</description><pubDate>Mon, 25 Apr 2022 00:00:00 GMT</pubDate></item><item><title>Announcing Placemark</title><link>https://www.placemark.io/post/announcing-placemark</link><guid>https://www.placemark.io/post/announcing-placemark</guid><description>Announcing a big new feature: the sign up button.</description><pubDate>Thu, 21 Apr 2022 00:00:00 GMT</pubDate></item><item><title>Engineering round up: Optimization</title><link>https://www.placemark.io/post/engineering-round-up-optimization</link><guid>https://www.placemark.io/post/engineering-round-up-optimization</guid><description>How we make Placemark faster, so you can make maps faster.</description><pubDate>Fri, 01 Apr 2022 00:00:00 GMT</pubDate></item><item><title>Placemark on the Geomob Podcast</title><link>https://www.placemark.io/post/placemark-on-the-geomob-podcast</link><guid>https://www.placemark.io/post/placemark-on-the-geomob-podcast</guid><description>A fun conversation with Ed Freyfogle about geo and business</description><pubDate>Mon, 28 Feb 2022 00:00:00 GMT</pubDate></item><item><title>The evolution of data-parsing leniency in Placemark</title><link>https://www.placemark.io/post/the-evolution-of-data-parsing-leniency-in-placemark</link><guid>https://www.placemark.io/post/the-evolution-of-data-parsing-leniency-in-placemark</guid><description>Accepting not-quite-valid data so you can make maps instead of fixing XML.</description><pubDate>Thu, 10 Feb 2022 00:00:00 GMT</pubDate></item><item><title>It&#39;s still too hard to make maps</title><link>https://www.placemark.io/post/its-still-too-hard-to-make-maps</link><guid>https://www.placemark.io/post/its-still-too-hard-to-make-maps</guid><description>It&#39;s too hard to make a map. It&#39;s also hard to say what making a map is.</description><pubDate>Tue, 25 Jan 2022 00:00:00 GMT</pubDate></item><item><title>2021 Map technology in review</title><link>https://www.placemark.io/post/2021-map-technology-in-review</link><guid>https://www.placemark.io/post/2021-map-technology-in-review</guid><description>From image formats to satellites, what seemed inspiring in geospatial technology this year.</description><pubDate>Thu, 23 Dec 2021 00:00:00 GMT</pubDate></item><item><title>Why we switched to Webflow</title><link>https://www.placemark.io/post/why-placemark-switched-the-blog-marketing-to-webflow</link><guid>https://www.placemark.io/post/why-placemark-switched-the-blog-marketing-to-webflow</guid><description>Why it might be a good idea to build your marketing site with a different technology stack than the one your application uses.</description><pubDate>Wed, 08 Dec 2021 00:00:00 GMT</pubDate></item><item><title>Maps, a decade later</title><link>https://www.placemark.io/post/maps-a-decade-later</link><guid>https://www.placemark.io/post/maps-a-decade-later</guid><description>Why maps are still interesting in 2021</description><pubDate>Sun, 21 Nov 2021 00:00:00 GMT</pubDate></item><item><title>Keeping the bugs away</title><link>https://www.placemark.io/post/keeping-the-bugs-away</link><guid>https://www.placemark.io/post/keeping-the-bugs-away</guid><description>How we use error logging, code analytics, uptime monitoring, and continuous deployment to power map editing tools you can rely on.</description><pubDate>Wed, 17 Nov 2021 00:00:00 GMT</pubDate></item><item><title>Escaping engineering FOMO</title><link>https://www.placemark.io/post/escaping-engineering-fomo</link><guid>https://www.placemark.io/post/escaping-engineering-fomo</guid><description>How to stop worrying about using the fastest web framework and just ship the thing.</description><pubDate>Mon, 01 Nov 2021 00:00:00 GMT</pubDate></item><item><title>Good magic with TypeScript</title><link>https://www.placemark.io/post/good-magic-with-typescript</link><guid>https://www.placemark.io/post/good-magic-with-typescript</guid><description>Some of our favorite open source modules that perfectly work with TypeScript and make our lives happier.</description><pubDate>Fri, 29 Oct 2021 00:00:00 GMT</pubDate></item><item><title>Engineering round up</title><link>https://www.placemark.io/post/engineering-round-up</link><guid>https://www.placemark.io/post/engineering-round-up</guid><description>From DNS to SQL to design, here&#39;s what&#39;s been changing with the Placemark map editor.</description><pubDate>Mon, 25 Oct 2021 00:00:00 GMT</pubDate></item><item><title>Choosing atoms</title><link>https://www.placemark.io/post/choosing-atoms</link><guid>https://www.placemark.io/post/choosing-atoms</guid><description>This is one of those hard-to-pin-down engineering concepts of how to shape your data, which trickles into the whole system design.</description><pubDate>Wed, 13 Oct 2021 00:00:00 GMT</pubDate></item><item><title>Values</title><link>https://www.placemark.io/post/values</link><guid>https://www.placemark.io/post/values</guid><description>Here are the goals and principles we&#39;re keeping in mind, building this geospatial application.</description><pubDate>Wed, 29 Sep 2021 00:00:00 GMT</pubDate></item><item><title>Thoughts on Collaboration</title><link>https://www.placemark.io/post/thoughts-on-collaboration</link><guid>https://www.placemark.io/post/thoughts-on-collaboration</guid><description>How we use Replicache to power real-time, multiplayer, collaborative map editing.</description><pubDate>Mon, 20 Sep 2021 00:00:00 GMT</pubDate></item><item><title>Tech brief: JSON Pointer</title><link>https://www.placemark.io/post/tech-brief-json-pointer</link><guid>https://www.placemark.io/post/tech-brief-json-pointer</guid><description>How JSON pointer lets you target and modify certain parts of JSON objects, and how this can be really useful for GeoJSON.</description><pubDate>Fri, 27 Aug 2021 00:00:00 GMT</pubDate></item><item><title>GitHub issues-only project management</title><link>https://www.placemark.io/post/github-issues-only-project-management</link><guid>https://www.placemark.io/post/github-issues-only-project-management</guid><description>My thoughts on why project management applications are often overkill, and using simple tools forces you to adopt more efficient practices as a small team.</description><pubDate>Mon, 19 Jul 2021 00:00:00 GMT</pubDate></item><item><title>The application stack: Blitz</title><link>https://www.placemark.io/post/the-application-stack-blitz</link><guid>https://www.placemark.io/post/the-application-stack-blitz</guid><description>There are lots of different ways to build a web application. It&#39;s about choosing the one that fits your problem area - here&#39;s why I ended up with Blitz.js, a level on top of Next.js, for Placemark.</description><pubDate>Mon, 10 May 2021 00:00:00 GMT</pubDate></item><item><title>Stack thinking</title><link>https://www.placemark.io/post/stack-thinking</link><guid>https://www.placemark.io/post/stack-thinking</guid><description>Here&#39;s my framework for how to think about some fundamental choices I have to make when building a company.</description><pubDate>Thu, 06 May 2021 00:00:00 GMT</pubDate></item></channel></rss>`;

describe("getBlog", () => {
  it("has a post", () => {
    vi.useFakeTimers().setSystemTime(new Date("2022-04-29"));
    expect(blogParseInner(fix)).toMatchInlineSnapshot(`
      {
        "description": "Just another Monday, with some improvements, fixes, and commentary!",
        "id": "https://www.placemark.io/post/changelog-april-25",
        "link": "https://www.placemark.io/post/changelog-april-25",
        "media": [],
        "pubDate": 2022-04-25T00:00:00.000Z,
        "title": "Changelog: April 25",
      }
    `);
    expect(blogParseInner(fix)).toMatchInlineSnapshot(`
      {
        "description": "Just another Monday, with some improvements, fixes, and commentary!",
        "id": "https://www.placemark.io/post/changelog-april-25",
        "link": "https://www.placemark.io/post/changelog-april-25",
        "media": [],
        "pubDate": 2022-04-25T00:00:00.000Z,
        "title": "Changelog: April 25",
      }
    `);
  });

  it("just null if feed is invalid", () => {
    vi.useFakeTimers().setSystemTime(new Date("2022-09-29"));
    expect(blogParseInner("<")).toMatchInlineSnapshot(`null`);
  });

  it("no result if post is too old", () => {
    vi.useFakeTimers().setSystemTime(new Date("2022-09-29"));
    expect(blogParseInner(fix)).toMatchInlineSnapshot(`null`);
  });
});
