import { EventDispatcher } from "./gui-events";
import { El } from "./gui-el";
import { getPageXY } from "./dom-utils";
import { utils } from "./gui-core";

export function ElementPosition(ref) {
  var self = this,
    el = El(ref),
    pageX = 0,
    pageY = 0,
    width = 0,
    height = 0;

  el.on("mouseover", update);
  if (window.onorientationchange)
    window.addEventListener("orientationchange", update);
  window.addEventListener("scroll", update);
  window.addEventListener("resize", update);

  // trigger an update, e.g. when map container is resized
  this.update = function () {
    update();
  };

  this.resize = function (w, h) {
    el.css("width", w).css("height", h);
    update();
  };

  this.width = function () {
    return width;
  };
  this.height = function () {
    return height;
  };
  this.position = function () {
    return {
      element: el.node(),
      pageX: pageX,
      pageY: pageY,
      width: width,
      height: height,
    };
  };

  function update() {
    var div = el.node(),
      xy = getPageXY(div),
      w = div.clientWidth,
      h = div.clientHeight,
      x = xy.x,
      y = xy.y,
      resized = w != width || h != height,
      moved = x != pageX || y != pageY;
    if (resized || moved) {
      pageX = x;
      pageY = y;
      width = w;
      height = h;
      self.dispatchEvent("change", self.position());
      if (resized) {
        self.dispatchEvent("resize", self.position());
      }
    }
  }
  update();
}

utils.inherit(ElementPosition, EventDispatcher);
